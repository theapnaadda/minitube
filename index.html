<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTube</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Light Mode Variables */
            --primary: #3ea6ff;
            --primary-dark: #065fd4;
            --secondary: #eef4ff;
            --accent-red: #ff4e45;
            --accent-green: #00c851;
            --accent-purple: #a855f7;
            --accent-yellow: #ffbb33;
            --white: #ffffff;
            --black: #0f0f0f;
            --text-main: #222222;
            --text-light: #606060;
            --border: #e0e0e0;
            --bg-body: #f9f9f9;
            --bg-nav: rgba(255,255,255,0.95);
            --bg-studio: #f4f6f8;
            --card-gradient: linear-gradient(135deg, #ffffff, #fffde7);
            --card-border-hover: rgba(255, 187, 51, 0.5);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.1);
            --header-h: 64px;
            --sidebar-w: 250px;
        }

        /* Dark Mode Override (Red/Black Theme) */
        body.dark-mode {
            --primary: #ff0000; /* Red Prominence */
            --primary-dark: #cc0000;
            --secondary: #1a1a1a;
            --white: #1f1f1f;
            --black: #ffffff;
            --text-main: #f1f1f1;
            --text-light: #aaaaaa;
            --border: #333333;
            --bg-body: #000000; /* Pure Black */
            --bg-nav: rgba(10, 10, 10, 0.95);
            --bg-studio: #121212;
            --card-gradient: linear-gradient(135deg, #1e1e1e, #2d0000); /* Black to dark red */
            --card-border-hover: rgba(255, 0, 0, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Typography Override for Headings */
        h1, h2, h3, h4, h5, .logo-text { font-family: 'Poppins', sans-serif; }

        /* --- Components --- */
        .btn {
            border: none;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { filter: brightness(0.9); }
        .btn-icon { background: transparent; color: var(--text-main); padding: 8px; border-radius: 50%; }
        .btn-icon:hover { background: var(--secondary); }

        /* --- Navbar --- */
        nav {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: var(--bg-nav);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .nav-left { display: flex; align-items: center; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .logo span { font-size: 34px; background: linear-gradient(45deg, var(--primary), var(--accent-yellow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; position: relative; top: -2px; }

        .nav-center { flex: 1; max-width: 600px; display: flex; align-items: center; margin: 0 20px; }
        .search-box {
            display: flex; flex: 1; height: 40px;
            border: 1px solid var(--border);
            border-radius: 40px;
            overflow: hidden;
            background: var(--secondary);
        }
        .search-box input {
            flex: 1; border: none; padding: 0 16px;
            background: transparent; color: var(--text-main);
            outline: none;
        }
        .search-box button {
            width: 60px; background: var(--secondary); border: none; border-left: 1px solid var(--border);
            cursor: pointer; color: var(--text-main);
        }
        .search-box:focus-within { border-color: var(--primary); box-shadow: 0 0 5px rgba(62, 166, 255, 0.2); }

        .nav-right { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: 600; cursor: pointer; object-fit: cover;}
        
        .theme-toggle-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 36px; height: 36px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            color: var(--text-main);
        }

        /* --- Sidebar --- */
        .sidebar {
            position: fixed;
            top: var(--header-h); left: 0; bottom: 0;
            width: var(--sidebar-w);
            background: var(--bg-nav);
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 900;
            padding: 12px;
            border-right: 1px solid var(--border);
        }
        .sidebar.closed { transform: translateX(-100%); }
        .sidebar-item {
            display: flex; align-items: center; gap: 20px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-main);
            font-size: 14px;
            margin-bottom: 4px;
        }
        .sidebar-item:hover { background: var(--secondary); }
        .sidebar-item.active { background: var(--secondary); font-weight: 600; }
        .sidebar-item .material-symbols-rounded { font-size: 22px; }
        .divider { height: 1px; background: var(--border); margin: 12px 0; }
        .sub-header { font-size: 13px; font-weight: 600; color: var(--text-light); padding: 8px 12px; text-transform: uppercase; }

        /* --- Main Content --- */
        .main-content {
            margin-left: var(--sidebar-w);
            margin-top: var(--header-h);
            padding: 24px;
            transition: margin-left 0.3s;
        }
        .main-content.full { margin-left: 0; }

        /* Category Bubbles */
        .categories {
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 16px;
            margin-bottom: 24px; scrollbar-width: none;
        }
        .cat-pill {
            padding: 6px 14px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-main);
        }
        .cat-pill:hover, .cat-pill.active {
            background: var(--black);
            color: var(--bg-body);
            border-color: var(--black);
        }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px 20px;
        }
        .video-card {
            background: var(--card-gradient);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            padding: 8px;
        }
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.15);
            border-color: var(--card-border-hover);
        }
        .thumbnail {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .video-card:hover .thumbnail img { transform: scale(1.05); }
        .duration {
            position: absolute; bottom: 6px; right: 6px;
            background: rgba(0,0,0,0.8); color: white;
            padding: 2px 6px; font-size: 11px; border-radius: 4px;
        }
        .meta { display: flex; gap: 12px; margin-top: 10px; }
        .meta-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .meta-text h3 { font-size: 15px; font-weight: 600; line-height: 1.3; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .meta-text p { font-size: 13px; color: var(--text-light); }

        /* --- Overlays (Watch, Studio, Auth) --- */
        .overlay {
            position: fixed; top: var(--header-h); left: 0; right: 0; bottom: 0;
            background: var(--bg-body);
            z-index: 1100;
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .overlay.active { display: block; }
        .modal-wrap {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--white);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
        }

        /* Watch Page Styles */
        .watch-container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        .player-wrapper { width: 100%; aspect-ratio: 16/9; background: black; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .player-wrapper iframe { width: 100%; height: 100%; border: none; }
        .watch-info h1 { font-size: 20px; margin-bottom: 12px; }
        .watch-actions { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; }
        .channel-info { display: flex; align-items: center; gap: 12px; }
        .desc-box { background: var(--secondary); padding: 16px; border-radius: 12px; font-size: 14px; white-space: pre-wrap; margin-bottom: 24px; }
        
        /* Comments */
        .comments-sec { margin-top: 24px; }
        .comment-input { display: flex; gap: 12px; margin-bottom: 20px; }
        .comment-input input { flex: 1; border: none; border-bottom: 1px solid var(--border); background: transparent; padding: 8px; color: var(--text-main); outline: none; }
        .comment-input input:focus { border-bottom: 2px solid var(--text-main); }
        .comment-list { display: flex; flex-direction: column; gap: 16px; }
        .comment-item { display: flex; gap: 12px; }
        .c-body { font-size: 14px; }
        .c-meta { font-size: 12px; color: var(--text-light); margin-bottom: 4px; }

        /* Studio */
        .studio-layout { display: flex; height: calc(100vh - var(--header-h)); }
        .studio-nav { width: 250px; border-right: 1px solid var(--border); padding: 20px; background: var(--bg-studio); }
        .studio-content { flex: 1; padding: 30px; overflow-y: auto; }
        .stat-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; }
        .stat-card.views { background: linear-gradient(135deg, #ff8800, #ff4e45); }
        .video-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .video-table th { text-align: left; color: var(--text-light); font-size: 12px; padding: 10px; }
        .video-table td { background: var(--white); padding: 12px; vertical-align: middle; }
        .video-table tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .video-table tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        /* Forms */
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-light); }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--secondary); color: var(--text-main); outline: none; }
        .form-input:focus { border-color: var(--primary); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; max-width: 280px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; }
            .nav-center { display: none; } /* Hide search on mobile init */
            .nav-center.active { display: flex; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-nav); z-index: 5; padding: 10px; margin: 0; max-width: none; }
            .studio-layout { flex-direction: column; }
            .studio-nav { width: 100%; height: auto; display: flex; overflow-x: auto; }
        }
        
        /* Confirmation Modal Specifics */
        .confirm-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-secondary { background: var(--text-light); color: white; }

        /* Notification Badge */
        .badge-dot { width: 10px; height: 10px; background: red; border-radius: 50%; position: absolute; top: 5px; right: 5px; border: 2px solid var(--bg-nav); display: none; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="nav-left">
            <button class="btn-icon" onclick="toggleSidebar()"><span class="material-symbols-rounded">menu</span></button>
            <div class="logo" onclick="goHome()">
                <span class="material-symbols-rounded">play_circle</span>
                <span class="logo-text">MiniTube</span>
            </div>
        </div>
        <div class="nav-center" id="searchContainer">
            <button class="btn-icon" style="display:none" id="closeMobileSearch" onclick="toggleMobileSearch()">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <div class="search-box">
                <input type="text" placeholder="Search" id="searchInput" onkeyup="handleSearch()">
                <button><span class="material-symbols-rounded">search</span></button>
            </div>
        </div>
        <div class="nav-right">
            <button class="btn-icon" id="mobileSearchTrigger" onclick="toggleMobileSearch()"><span class="material-symbols-rounded">search</span></button>
            <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                <span class="material-symbols-rounded" id="themeIcon">dark_mode</span>
            </button>
            <button class="btn-icon" onclick="openUploadModal()" style="color: var(--accent-red)"><span class="material-symbols-rounded">video_call</span></button>
            <div style="position: relative;">
                <button class="btn-icon"><span class="material-symbols-rounded">notifications</span></button>
                <div class="badge-dot" id="notifBadge"></div>
            </div>
            <div id="authBtnContainer">
                <!-- Injected via JS -->
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-item active" onclick="goHome()"><span class="material-symbols-rounded" style="color: var(--accent-red)">home</span> Home</div>
        <div class="sidebar-item" onclick="openStudio()"><span class="material-symbols-rounded" style="color: var(--accent-yellow)">bar_chart</span> Studio</div>
        <div class="sidebar-item" onclick="openHistory()"><span class="material-symbols-rounded" style="color: var(--accent-purple)">history</span> History</div>
        <div class="sidebar-item" onclick="openLiked()"><span class="material-symbols-rounded" style="color: var(--primary)">thumb_up</span> Liked Videos</div>
        <div class="divider"></div>
        <div class="sub-header">Subscriptions</div>
        <div id="subList">
            <!-- Dynamic Subs -->
            <p style="padding: 12px; font-size: 13px; color: var(--text-light);">Sign in to see subscriptions</p>
        </div>
        <div class="divider"></div>
        <div id="logoutBtnArea"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="categories" id="categories">
            <div class="cat-pill active" onclick="filterCat('All')">All</div>
            <div class="cat-pill" onclick="filterCat('Music')">Music</div>
            <div class="cat-pill" onclick="filterCat('Gaming')">Gaming</div>
            <div class="cat-pill" onclick="filterCat('Code')">Code</div>
            <div class="cat-pill" onclick="filterCat('Vlogs')">Vlogs</div>
            <div class="cat-pill" onclick="filterCat('News')">News</div>
        </div>
        <div class="video-grid" id="videoGrid">
            <!-- Videos injected here -->
        </div>
    </div>

    <!-- Watch Page Overlay -->
    <div class="overlay" id="watchOverlay">
        <div class="watch-container">
            <button class="btn" onclick="closeWatch()" style="margin-bottom: 10px;">
                <span class="material-symbols-rounded">arrow_back</span> Back to Home
            </button>
            <div class="player-wrapper">
                <iframe id="videoPlayer" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div class="watch-info">
                <h1 id="wTitle">Video Title</h1>
                <div class="watch-actions">
                    <div class="channel-info">
                        <img src="" id="wAvatar" class="meta-avatar">
                        <div>
                            <h4 id="wChannel">Channel Name</h4>
                            <span id="wSubs" style="font-size: 12px; color: var(--text-light)">0 subscribers</span>
                        </div>
                        <button class="btn" id="subBtn" onclick="toggleSubscribe()" style="background: var(--black); color: var(--bg-body); border-radius: 30px;">Subscribe</button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" style="background: var(--secondary); border-radius: 30px;" id="likeBtn" onclick="toggleLike()">
                            <span class="material-symbols-rounded" id="likeIcon">thumb_up</span> <span id="wLikes">0</span>
                        </button>
                        <button class="btn" style="background: var(--secondary); border-radius: 30px;">
                            <span class="material-symbols-rounded">share</span> Share
                        </button>
                    </div>
                </div>
                <div class="desc-box">
                    <p style="font-weight: bold; margin-bottom: 8px;"><span id="wViews">0</span> views • <span id="wDate">Just now</span></p>
                    <p id="wDesc">Description goes here...</p>
                </div>
                <!-- Comments -->
                <div class="comments-sec">
                    <h3 id="cCount">Comments</h3>
                    <div class="comment-input">
                        <img id="cUserAvatar" src="https://ui-avatars.com/api/?name=Guest" class="meta-avatar">
                        <input type="text" id="commentText" placeholder="Add a comment...">
                        <button class="btn btn-primary" onclick="postComment()">Comment</button>
                    </div>
                    <div class="comment-list" id="commentList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Studio Overlay -->
    <div class="overlay" id="studioOverlay" style="background: var(--bg-studio); z-index: 1150;">
        <div class="studio-layout">
            <div class="studio-nav">
                <div class="sidebar-item active"><span class="material-symbols-rounded">dashboard</span> Dashboard</div>
                <div class="sidebar-item" onclick="closeStudio()"><span class="material-symbols-rounded">arrow_back</span> Exit Studio</div>
            </div>
            <div class="studio-content">
                <h2 style="margin-bottom: 20px;">Channel Dashboard</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>Total Videos</h3>
                        <h1 id="sTotalVideos">0</h1>
                    </div>
                    <div class="stat-card views">
                        <h3>Total Views</h3>
                        <h1 id="sTotalViews">0</h1>
                    </div>
                </div>
                
                <div style="background: var(--white); padding: 20px; border-radius: 16px; box-shadow: var(--shadow-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Your Videos</h3>
                        <button class="btn btn-primary" onclick="openChannelAnalytics()">View Analytics</button>
                    </div>
                    <table class="video-table">
                        <thead><tr><th>Video</th><th>Date</th><th>Views</th><th>Actions</th></tr></thead>
                        <tbody id="studioTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Auth Modal -->
    <div class="modal-wrap" id="authModal">
        <div class="modal-box">
            <button class="btn-icon" style="position: absolute; right: 10px; top: 10px;" onclick="closeModals()"><span class="material-symbols-rounded">close</span></button>
            <span class="material-symbols-rounded" style="font-size: 50px; color: var(--primary);">account_circle</span>
            <h2 id="authTitle" style="margin: 10px 0;">Sign In</h2>
            <div class="form-group">
                <input type="email" id="email" class="form-input" placeholder="Email">
            </div>
            <div class="form-group">
                <input type="password" id="password" class="form-input" placeholder="Password">
            </div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="performAuth()">Submit</button>
            <button class="btn" style="width: 100%; justify-content: center; margin-top: 10px; border: 1px solid var(--border);" onclick="googleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Sign in with Google
            </button>
            <p style="margin-top: 15px; font-size: 14px; cursor: pointer; color: var(--primary);" onclick="toggleAuthMode()" id="authToggle">Create an account</p>
        </div>
    </div>

    <!-- Upload/Edit Modal -->
    <div class="modal-wrap" id="uploadModal">
        <div class="modal-box" style="max-width: 500px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="uploadTitle">Upload Video</h2>
                <button class="btn-icon" onclick="closeModals()"><span class="material-symbols-rounded">close</span></button>
            </div>
            <input type="hidden" id="editVidId">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="uTitle" class="form-input" placeholder="Video Title">
            </div>
            <div class="form-group">
                <label>Thumbnail Image (Upload)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="file" id="uThumbFile" class="form-input" accept="image/*">
                </div>
                <input type="hidden" id="uThumbUrl"> <!-- Stores the ImgBB URL -->
                <small id="uploadStatus" style="color: var(--primary); display: none;">Uploading image...</small>
            </div>
            <div class="form-group">
                <label>Video URL (YouTube/GDrive)</label>
                <input type="text" id="uVidUrl" class="form-input" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Duration (MM:SS)</label>
                <input type="text" id="uDuration" class="form-input" placeholder="00:00">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="uDesc" class="form-input" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="submitVideo()">Save Video</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal-wrap" id="analyticsModal">
        <div class="modal-box" style="max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="anaTitle">Analytics</h2>
                <button class="btn-icon" onclick="closeModals()"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div style="height: 300px; margin-bottom: 30px;">
                <canvas id="chartRealtime"></canvas>
            </div>
            <div style="height: 300px;">
                <canvas id="chartPerf"></canvas>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div class="modal-wrap" id="confirmModal">
        <div class="modal-box">
            <span class="material-symbols-rounded" style="font-size: 48px; color: var(--accent-yellow);">warning</span>
            <h2 id="confirmTitle" style="margin: 10px 0;">Are you sure?</h2>
            <p id="confirmMsg" style="color: var(--text-light);">This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" onclick="closeModals()">Cancel</button>
                <button class="btn btn-danger" id="confirmYesBtn">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, update, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBl-OXnSy4L42asPTwhtOEAoSFRumuQr4o",
            authDomain: "minitube-f4d8e.firebaseapp.com",
            databaseURL: "https://minitube-f4d8e-default-rtdb.firebaseio.com",
            projectId: "minitube-f4d8e",
            storageBucket: "minitube-f4d8e.firebasestorage.app",
            messagingSenderId: "883145934772",
            appId: "1:883145934772:web:18496cb3aa081e7a8b14e1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        // Global State
        let currentUser = null;
        let allVideos = {};
        let currentVidId = null;
        let isRegister = false;
        let charts = {};
        let imgbbKey = "43e4c0f0899f31b9257bd93257877863";

        // --- Auth System ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUI();
        });

        function updateUI() {
            const container = document.getElementById('authBtnContainer');
            const logoutArea = document.getElementById('logoutBtnArea');
            const subList = document.getElementById('subList');
            const cAvatar = document.getElementById('cUserAvatar');

            if (currentUser) {
                // Navbar Avatar
                const initial = currentUser.displayName ? currentUser.displayName[0].toUpperCase() : currentUser.email[0].toUpperCase();
                const photo = currentUser.photoURL ? currentUser.photoURL : `https://ui-avatars.com/api/?name=${initial}&background=random`;
                
                container.innerHTML = `<img src="${photo}" class="user-avatar" onclick="openStudio()">`;
                cAvatar.src = photo;

                // Sidebar
                logoutArea.innerHTML = `<div class="sidebar-item" onclick="confirmLogout()"><span class="material-symbols-rounded">logout</span> Sign Out</div>`;
                
                // Load Subs
                const subRef = ref(db, `users/${currentUser.uid}/subscriptions`);
                onValue(subRef, (snap) => {
                    const subs = snap.val();
                    subList.innerHTML = '';
                    if (subs) {
                        Object.keys(subs).forEach(name => {
                            if(subs[name] === true) {
                                subList.innerHTML += `
                                    <div class="sidebar-item">
                                        <img src="https://ui-avatars.com/api/?name=${name}&background=random" style="width:24px;height:24px;border-radius:50%;margin-right:8px;">
                                        ${name}
                                    </div>`;
                            }
                        });
                    } else {
                        subList.innerHTML = '<p style="padding:12px;font-size:13px;color:var(--text-light)">No subscriptions yet.</p>';
                    }
                });

            } else {
                container.innerHTML = `<button class="btn" style="border:1px solid var(--border);color:var(--primary)" onclick="openAuthModal()">
                    <span class="material-symbols-rounded">account_circle</span> Sign In
                </button>`;
                logoutArea.innerHTML = '';
                subList.innerHTML = '<p style="padding:12px;font-size:13px;color:var(--text-light)">Sign in to see subscriptions</p>';
                cAvatar.src = "https://ui-avatars.com/api/?name=Guest";
            }
        }

        window.openAuthModal = () => { document.getElementById('authModal').style.display = 'flex'; };
        window.closeModals = () => { 
            document.querySelectorAll('.modal-wrap').forEach(m => m.style.display = 'none'); 
        };
        window.toggleAuthMode = () => {
            isRegister = !isRegister;
            document.getElementById('authTitle').innerText = isRegister ? "Register" : "Sign In";
            document.getElementById('authToggle').innerText = isRegister ? "Sign In instead" : "Create an account";
        };

        window.performAuth = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                if (isRegister) await createUserWithEmailAndPassword(auth, e, p);
                else await signInWithEmailAndPassword(auth, e, p);
                window.closeModals();
            } catch (err) { alert(err.message); }
        };

        window.googleLogin = async () => {
            try {
                await signInWithPopup(auth, googleProvider);
                window.closeModals();
            } catch (err) { alert(err.message); }
        };

        window.confirmLogout = () => {
            showConfirm("Logout?", "Are you sure you want to sign out?", () => {
                signOut(auth);
                window.location.reload(); // Hard refresh to clear states
            });
        };

        // --- Custom Confirmation Modal ---
        function showConfirm(title, msg, callback) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMsg').innerText = msg;
            const btn = document.getElementById('confirmYesBtn');
            // Remove old listeners to prevent stacking
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => {
                callback();
                document.getElementById('confirmModal').style.display = 'none';
            };
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // --- Theme System ---
        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').innerText = isDark ? 'light_mode' : 'dark_mode';
        };
        // Init Theme
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('themeIcon').innerText = 'light_mode';
        }

        // --- Video Logic ---
        const videosRef = ref(db, 'videos');
        onValue(videosRef, (snapshot) => {
            const data = snapshot.val();
            allVideos = data || {};
            renderGrid(allVideos);
            updateNotification(data);
        });

        function renderGrid(vids) {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '';
            if(!vids) return;

            Object.entries(vids).reverse().forEach(([id, v]) => {
                const timeStr = timeAgo(v.timestamp);
                const viewsStr = formatViews(v.views || 0);
                const uInitial = v.uploader ? v.uploader[0] : 'U';
                
                grid.innerHTML += `
                    <div class="video-card" onclick="window.openWatch('${id}')">
                        <div class="thumbnail">
                            <img src="${v.thumbnail}" loading="lazy">
                            <div class="duration">${v.duration || '00:00'}</div>
                        </div>
                        <div class="meta">
                            <img src="https://ui-avatars.com/api/?name=${v.uploader}&background=random" class="meta-avatar">
                            <div class="meta-text">
                                <h3>${v.title}</h3>
                                <p>${v.uploader}</p>
                                <p>${viewsStr} views • ${timeStr}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        window.filterCat = (cat) => {
            document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            
            if (cat === 'All') {
                renderGrid(allVideos);
            } else {
                const filtered = {};
                Object.entries(allVideos).forEach(([id, v]) => {
                    // Simple keyword match in title/desc
                    if ((v.title + v.description).toLowerCase().includes(cat.toLowerCase())) {
                        filtered[id] = v;
                    }
                });
                renderGrid(filtered);
            }
        };

        window.handleSearch = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = {};
            Object.entries(allVideos).forEach(([id, v]) => {
                if (v.title.toLowerCase().includes(q)) filtered[id] = v;
            });
            renderGrid(filtered);
        };

        // --- Watch Page ---
        window.openWatch = async (id) => {
            currentVidId = id;
            const v = allVideos[id];
            if (!v) return;

            // Update View Count
            runTransaction(ref(db, `videos/${id}/views`), (views) => (views || 0) + 1);
            
            // Analytics View Log
            const viewKey = Date.now(); // Simple timestamp key
            update(ref(db, `analytics/${id}/views/${viewKey}`), { t: Date.now() });

            // History (if logged in)
            if (currentUser) {
                const histRef = push(ref(db, `users/${currentUser.uid}/history`));
                set(histRef, { videoId: id, timestamp: Date.now() });
            }

            // Populate UI
            document.getElementById('videoPlayer').src = convertToEmbed(v.videoUrl);
            document.getElementById('wTitle').innerText = v.title;
            document.getElementById('wChannel').innerText = v.uploader || "Unknown";
            document.getElementById('wAvatar').src = `https://ui-avatars.com/api/?name=${v.uploader}&background=random`;
            document.getElementById('wViews').innerText = formatViews((v.views || 0) + 1);
            document.getElementById('wDate').innerText = timeAgo(v.timestamp);
            document.getElementById('wDesc').innerText = v.description;
            document.getElementById('wLikes').innerText = "0"; // Placeholder, real count below

            // Check Sub Status
            updateSubButton(v.uploader);

            // Check Like Status & Count
            const likesRef = ref(db, `likes/${id}`);
            onValue(likesRef, (snap) => {
                const likes = snap.val() || {};
                const count = Object.keys(likes).length;
                document.getElementById('wLikes').innerText = formatViews(count);
                const btn = document.getElementById('likeBtn');
                const icon = document.getElementById('likeIcon');
                if (currentUser && likes[currentUser.uid]) {
                    icon.classList.add('filled'); // Material Symbols filled logic could be applied via font variation or just color
                    icon.style.fontVariationSettings = "'FILL' 1";
                    btn.style.background = "var(--primary)";
                    btn.style.color = "white";
                } else {
                    icon.style.fontVariationSettings = "'FILL' 0";
                    btn.style.background = "var(--secondary)";
                    btn.style.color = "var(--text-main)";
                }
            });

            // Load Comments
            loadComments(id);

            document.getElementById('watchOverlay').classList.add('active');
        };

        window.closeWatch = () => {
            document.getElementById('watchOverlay').classList.remove('active');
            document.getElementById('videoPlayer').src = "";
            currentVidId = null;
        };

        // --- Interaction Logic ---
        window.toggleLike = () => {
            if (!currentUser) return window.openAuthModal();
            const likeRef = ref(db, `likes/${currentVidId}/${currentUser.uid}`);
            get(likeRef).then(snap => {
                if (snap.exists()) remove(likeRef);
                else set(likeRef, true);
            });
        };

        window.toggleSubscribe = () => {
            if (!currentUser) return window.openAuthModal();
            const uploader = document.getElementById('wChannel').innerText;
            if (uploader === currentUser.displayName) return alert("Can't subscribe to yourself!");

            const subRef = ref(db, `users/${currentUser.uid}/subscriptions/${uploader}`);
            get(subRef).then(snap => {
                if (snap.exists()) {
                    remove(subRef);
                    document.getElementById('subBtn').innerText = "Subscribe";
                    document.getElementById('subBtn').style.background = "var(--black)";
                    document.getElementById('subBtn').style.color = "var(--bg-body)";
                } else {
                    set(subRef, true);
                    document.getElementById('subBtn').innerText = "Subscribed";
                    document.getElementById('subBtn').style.background = "var(--secondary)";
                    document.getElementById('subBtn').style.color = "var(--primary-dark)";
                }
            });
        };

        function updateSubButton(uploader) {
             const btn = document.getElementById('subBtn');
             if(!currentUser) {
                 btn.innerText = "Subscribe";
                 btn.style.background = "var(--black)";
                 return;
             }
             get(ref(db, `users/${currentUser.uid}/subscriptions/${uploader}`)).then(snap => {
                 if(snap.exists()) {
                    btn.innerText = "Subscribed";
                    btn.style.background = "var(--secondary)";
                    btn.style.color = "var(--primary-dark)";
                 } else {
                    btn.innerText = "Subscribe";
                    btn.style.background = "var(--black)";
                    btn.style.color = "var(--bg-body)";
                 }
             });
        }

        window.postComment = () => {
            if (!currentUser) return window.openAuthModal();
            const txt = document.getElementById('commentText').value;
            if (!txt.trim()) return;

            push(ref(db, `comments/${currentVidId}`), {
                text: txt,
                user: currentUser.displayName || currentUser.email.split('@')[0],
                uid: currentUser.uid,
                time: Date.now()
            });
            document.getElementById('commentText').value = "";
        };

        function loadComments(vidId) {
            onValue(ref(db, `comments/${vidId}`), (snap) => {
                const list = document.getElementById('commentList');
                list.innerHTML = "";
                const coms = snap.val();
                if (coms) {
                    document.getElementById('cCount').innerText = Object.keys(coms).length + " Comments";
                    Object.values(coms).reverse().forEach(c => {
                        list.innerHTML += `
                            <div class="comment-item">
                                <img src="https://ui-avatars.com/api/?name=${c.user}&background=random" class="meta-avatar">
                                <div>
                                    <div class="c-meta">@${c.user} • ${timeAgo(c.time)}</div>
                                    <div class="c-body">${c.text}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    document.getElementById('cCount').innerText = "Comments";
                    list.innerHTML = "<div style='color:gray; font-style:italic'>No comments yet.</div>";
                }
            });
        }

        // --- Studio & Upload ---
        window.openStudio = () => {
            if (!currentUser) return window.openAuthModal();
            document.getElementById('studioOverlay').classList.add('active');
            renderStudioTable();
        };

        window.closeStudio = () => { document.getElementById('studioOverlay').classList.remove('active'); };

        function renderStudioTable() {
            const tbody = document.getElementById('studioTableBody');
            tbody.innerHTML = '';
            let myVids = [];
            let totalViews = 0;

            Object.entries(allVideos).forEach(([id, v]) => {
                if (v.uid === currentUser.uid) {
                    myVids.push({...v, id});
                    totalViews += (v.views || 0);
                }
            });

            document.getElementById('sTotalVideos').innerText = myVids.length;
            document.getElementById('sTotalViews').innerText = formatViews(totalViews);

            if (myVids.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:gray">No videos uploaded.</td></tr>';
                return;
            }

            myVids.reverse().forEach(v => {
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <img src="${v.thumbnail}" style="width:80px;border-radius:6px;">
                                <span>${v.title}</span>
                            </div>
                        </td>
                        <td>${new Date(v.timestamp).toLocaleDateString()}</td>
                        <td>${v.views || 0}</td>
                        <td>
                            <button class="btn-icon" style="color:var(--accent-green)" onclick="openAnalytics('${v.id}')"><span class="material-symbols-rounded">bar_chart</span></button>
                            <button class="btn-icon" style="color:var(--accent-purple)" onclick="openEdit('${v.id}')"><span class="material-symbols-rounded">edit</span></button>
                            <button class="btn-icon" style="color:var(--accent-red)" onclick="deleteVideo('${v.id}')"><span class="material-symbols-rounded">delete</span></button>
                        </td>
                    </tr>
                `;
            });
        }

        window.openUploadModal = () => {
            if (!currentUser) return window.openAuthModal();
            document.getElementById('uploadModal').style.display = 'flex';
            document.getElementById('uploadTitle').innerText = "Upload Video";
            document.getElementById('editVidId').value = "";
            document.getElementById('uTitle').value = "";
            document.getElementById('uThumbFile').value = ""; // Clear file
            document.getElementById('uThumbUrl').value = "";
            document.getElementById('uVidUrl').value = "";
            document.getElementById('uDuration').value = "";
            document.getElementById('uDesc').value = "";
        };

        window.openEdit = (id) => {
            const v = allVideos[id];
            document.getElementById('uploadModal').style.display = 'flex';
            document.getElementById('uploadTitle').innerText = "Edit Video";
            document.getElementById('editVidId').value = id;
            document.getElementById('uTitle').value = v.title;
            document.getElementById('uThumbUrl').value = v.thumbnail;
            document.getElementById('uVidUrl').value = v.videoUrl;
            document.getElementById('uDuration').value = v.duration;
            document.getElementById('uDesc').value = v.description;
        };

        // ImgBB Upload Helper
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error("Image upload failed");
                }
            } catch (error) {
                console.error(error);
                alert("Thumbnail upload failed.");
                return null;
            }
        }

        window.submitVideo = async () => {
            const id = document.getElementById('editVidId').value;
            const title = document.getElementById('uTitle').value;
            const vidUrl = document.getElementById('uVidUrl').value;
            const duration = document.getElementById('uDuration').value;
            const desc = document.getElementById('uDesc').value;
            const fileInput = document.getElementById('uThumbFile');
            let thumbUrl = document.getElementById('uThumbUrl').value;

            if (!title || !vidUrl) return alert("Title and Video URL are required.");

            const status = document.getElementById('uploadStatus');
            
            // Handle File Upload if selected
            if (fileInput.files.length > 0) {
                status.style.display = 'block';
                const uploadedUrl = await uploadImageToImgBB(fileInput.files[0]);
                status.style.display = 'none';
                if (!uploadedUrl) return; // Stop if failed
                thumbUrl = uploadedUrl;
            } else if (!thumbUrl) {
                // If no file and no existing URL (new upload without file)
                thumbUrl = "https://placehold.co/600x400?text=No+Thumbnail"; 
            }

            const data = {
                title,
                thumbnail: thumbUrl,
                videoUrl: vidUrl,
                duration,
                description: desc,
                uploader: currentUser.displayName || currentUser.email.split('@')[0],
                uid: currentUser.uid
            };

            if (id) {
                // Update
                update(ref(db, `videos/${id}`), data);
            } else {
                // Create
                data.timestamp = Date.now();
                data.views = 0;
                push(ref(db, 'videos'), data);
            }
            window.closeModals();
            if(document.getElementById('studioOverlay').classList.contains('active')) renderStudioTable();
        };

        window.deleteVideo = (id) => {
            showConfirm("Delete Video?", "This will permanently delete this video and its statistics.", () => {
                remove(ref(db, `videos/${id}`));
                renderStudioTable();
            });
        };

        // --- Analytics (Chart.js) ---
        window.openAnalytics = (vidId) => {
            document.getElementById('analyticsModal').style.display = 'flex';
            const v = allVideos[vidId];
            document.getElementById('anaTitle').innerText = v.title;
            
            // Fetch view logs
            get(ref(db, `analytics/${vidId}/views`)).then(snap => {
                const logs = snap.val() || {};
                drawCharts(Object.values(logs));
            });
        };
        
        window.openChannelAnalytics = () => {
            document.getElementById('analyticsModal').style.display = 'flex';
            document.getElementById('anaTitle').innerText = "Channel Analytics";
            
            // Aggregate all videos
            const myVids = Object.keys(allVideos).filter(k => allVideos[k].uid === currentUser.uid);
            let allLogs = [];
            
            const promises = myVids.map(vidId => get(ref(db, `analytics/${vidId}/views`)).then(s => s.val()));
            
            Promise.all(promises).then(results => {
                results.forEach(r => { if(r) allLogs = allLogs.concat(Object.values(r)); });
                drawCharts(allLogs);
            });
        };

        function drawCharts(data) {
            // Destroy old
            if (charts['realtime']) charts['realtime'].destroy();
            if (charts['perf']) charts['perf'].destroy();

            // 1. Realtime (Last 24h)
            const now = Date.now();
            const buckets = new Array(24).fill(0);
            data.forEach(d => {
                const diff = (now - d.t) / (1000 * 60 * 60);
                if (diff < 24) buckets[Math.floor(diff)]++;
            });
            // Reverse buckets for chart (Older -> Newer)
            const realData = buckets.reverse();
            
            const ctx1 = document.getElementById('chartRealtime').getContext('2d');
            charts['realtime'] = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Array.from({length:24}, (_, i) => `${i}h ago`).reverse(),
                    datasets: [{ label: 'Views', data: realData, backgroundColor: '#00c851' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 2. Performance (Timeline)
            const dates = {};
            data.forEach(d => {
                const day = new Date(d.t).toLocaleDateString();
                dates[day] = (dates[day] || 0) + 1;
            });
            const sortedKeys = Object.keys(dates).sort((a,b) => new Date(a) - new Date(b));
            
            const ctx2 = document.getElementById('chartPerf').getContext('2d');
            charts['perf'] = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{ 
                        label: 'Total Views', 
                        data: sortedKeys.map(k => dates[k]), 
                        borderColor: '#3ea6ff',
                        backgroundColor: 'rgba(62, 166, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- Helpers ---
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const mc = document.getElementById('mainContent');
            if(window.innerWidth <= 768) {
                sb.classList.toggle('mobile-open');
            } else {
                sb.classList.toggle('closed');
                mc.classList.toggle('full');
            }
        };

        window.toggleMobileSearch = () => {
            document.getElementById('searchContainer').classList.toggle('active');
            document.getElementById('mobileSearchTrigger').style.display = 
                document.getElementById('searchContainer').classList.contains('active') ? 'none' : 'block';
            document.getElementById('closeMobileSearch').style.display = 
                document.getElementById('searchContainer').classList.contains('active') ? 'block' : 'none';
        };

        window.goHome = () => {
            document.getElementById('watchOverlay').classList.remove('active');
            document.getElementById('studioOverlay').classList.remove('active');
            document.getElementById('categories').style.display = 'flex';
            renderGrid(allVideos);
            // close mobile sidebar
            document.getElementById('sidebar').classList.remove('mobile-open');
        };

        window.openHistory = () => {
            if(!currentUser) return window.openAuthModal();
            document.getElementById('categories').style.display = 'none';
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<p>Loading History...</p>';
            
            get(ref(db, `users/${currentUser.uid}/history`)).then(snap => {
                const hist = snap.val();
                if(!hist) { grid.innerHTML = '<p>No history found.</p>'; return; }
                const histVids = {};
                Object.values(hist).forEach(h => {
                    if(allVideos[h.videoId]) histVids[h.videoId] = allVideos[h.videoId]; // This dedupes by ID technically
                });
                renderGrid(histVids);
            });
        };

        window.openLiked = () => {
            if(!currentUser) return window.openAuthModal();
            document.getElementById('categories').style.display = 'none';
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<p>Loading Liked Videos...</p>';

            // In a real optimized app, you'd index likes better. Here we scan.
            let likedVids = {};
            const promises = [];
            // We need to check all videos to see if THIS user liked them? 
            // Better: We query likes node? No, likes structure is likes/{vidId}/{userId}.
            // It's hard to get "Videos user liked" efficiently without a reverse index.
            // For this demo, we scan `likes` node.
            get(ref(db, 'likes')).then(snap => {
                const allLikes = snap.val() || {};
                Object.keys(allLikes).forEach(vidId => {
                    if(allLikes[vidId][currentUser.uid]) {
                        if(allVideos[vidId]) likedVids[vidId] = allVideos[vidId];
                    }
                });
                if(Object.keys(likedVids).length === 0) grid.innerHTML = '<p>No liked videos.</p>';
                else renderGrid(likedVids);
            });
        };

        function formatViews(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n;
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mins ago";
            return "Just now";
        }

        function convertToEmbed(url) {
            if (!url) return "";
            // YouTube
            const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            if (ytMatch) return `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1`;
            // GDrive
            const driveMatch = url.match(/\/d\/(.*?)\//);
            if (driveMatch) return `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
            return url;
        }

        function updateNotification(data) {
            // Simple logic: If videos exist, show dot.
            // Ideally compare against last visited time.
            const badge = document.getElementById('notifBadge');
            if (data && Object.keys(data).length > 0) badge.style.display = 'block';
        }

        // Attach global listeners for clicking outside modals
        window.onclick = (e) => {
            if (e.target.classList.contains('modal-wrap')) window.closeModals();
        };

    </script>
</body>
</html>